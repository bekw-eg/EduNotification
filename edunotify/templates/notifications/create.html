{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="card">
    <h2 class="card-title">–ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É “õ–æ—Å—É</h2>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="POST" enctype="multipart/form-data" id="notificationForm">
        {% csrf_token %}
        
        <!-- –§–æ—Ä–º–∞ ”©—Ä—ñ—Å—Ç–µ—Ä—ñ–Ω “õ–æ–ª–º–µ–Ω –∂–∞–∑—É –æ—Ä–Ω—ã–Ω–∞ Django —Ñ–æ—Ä–º–∞—Å—ã–Ω –ø–∞–π–¥–∞–ª–∞–Ω—É -->
        {{ form.non_field_errors }}
        
        <div class="form-group">
            <label class="form-label">–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É —Ç–∞“õ—ã—Ä—ã–±—ã *</label>
            {{ form.title }}
            {{ form.title.errors }}
        </div>
        
        <div class="form-group">
            <label class="form-label">–ú–∞–∑–º“±–Ω—ã *</label>
            {{ form.content }}
            {{ form.content.errors }}
        </div>
        
        <div class="form-group">
            <label class="form-label">–°—É—Ä–µ—Ç “õ–æ—Å—É (–º—ñ–Ω–¥–µ—Ç—Ç—ñ –µ–º–µ—Å)</label>
            {{ form.image }}
            <span class="form-text">–¢–µ–∫ JPG, PNG, GIF, WebP —Ñ–æ—Ä–º–∞—Ç—Ç–∞—Ä—ã. –ú–∞–∫—Å. ”©–ª—à–µ–º—ñ: 5MB</span>
            
            <div id="imagePreview" class="mt-3" style="display: none;">
                <img id="preview" class="img-thumbnail" style="max-width: 300px; max-height: 200px;">
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImage()">
                    –°—É—Ä–µ—Ç—Ç—ñ –∂–æ—é
                </button>
            </div>
            {{ form.image.errors }}
        </div>

        <div class="form-group">
            <div class="form-check">
                {{ form.is_important }}
                <label class="form-check-label" for="{{ form.is_important.id_for_label }}">
                    üö® –ú–∞“£—ã–∑–¥—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É (–±–∞—Ä–ª—ã“õ –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã–ª–∞—Ä“ì–∞ –µ—Å–∫–µ—Ä—Ç—É –±–æ–ª–∞–¥—ã)
                </label>
            </div>
        </div>
        
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">–•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É —Ç“Ø—Ä—ñ *</label>
                    {{ form.notification_type }}
                    {{ form.notification_type.errors }}
                </div>
            </div>
            
            <div class="col-6">
                <div class="form-group" id="groupField" style="display: none;">
                    <label class="form-label">–ì—Ä—É–ø–ø–∞ *</label>
                    {{ form.group }}
                    {{ form.group.errors }}
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–¥—ã –∂–∞—Ä–∏—è–ª–∞—É
            </button>
            <a href="{% url 'notifications' %}" class="btn btn-secondary">–ê—Ä—Ç“õ–∞</a>
        </div>
    </form>
</div>

<script>
// –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É —Ç“Ø—Ä—ñ–Ω–µ “õ–∞—Ä–∞–π –≥—Ä—É–ø–ø–∞ ”©—Ä—ñ—Å—ñ–Ω –∫”©—Ä—Å–µ—Ç—É/–∂–∞—Å—ã—Ä—É
document.addEventListener('DOMContentLoaded', function() {
    const notificationType = document.getElementById('id_notification_type');
    const groupField = document.getElementById('groupField');
    
    function toggleGroupField() {
        if (notificationType.value === 'group') {
            groupField.style.display = 'block';
        } else {
            groupField.style.display = 'none';
        }
    }
    
    // –ë–∞—Å—Ç–∞–ø“õ—ã –∫“Ø–π
    toggleGroupField();
    
    // ”®–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç—ã“£–¥–∞—É
    if (notificationType) {
        notificationType.addEventListener('change', toggleGroupField);
    }
    
    // –°—É—Ä–µ—Ç—Ç—ñ –∞–ª–¥—ã–Ω –∞–ª–∞ “õ–∞—Ä–∞—É
    const imageInput = document.getElementById('id_image');
    if (imageInput) {
        imageInput.addEventListener('change', previewImage);
    }
});

function previewImage(event) {
    const input = event.target;
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            previewContainer.style.display = 'block';
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

function removeImage() {
    const imageInput = document.getElementById('id_image');
    const previewContainer = document.getElementById('imagePreview');
    
    if (imageInput) {
        imageInput.value = '';
        previewContainer.style.display = 'none';
    }
}

// –§–æ—Ä–º–∞–Ω—ã –∂—ñ–±–µ—Ä—É –∞–ª–¥—ã–Ω–¥–∞ —Ç–µ–∫—Å–µ—Ä—É
document.getElementById('notificationForm').addEventListener('submit', function(e) {
    const imageInput = document.getElementById('id_image');
    
    // –°—É—Ä–µ—Ç ”©–ª—à–µ–º—ñ–Ω —Ç–µ–∫—Å–µ—Ä—É
    if (imageInput && imageInput.files.length > 0) {
        const fileSize = imageInput.files[0].size;
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        if (fileSize > maxSize) {
            e.preventDefault();
            alert('–°—É—Ä–µ—Ç—Ç—ñ“£ ”©–ª—à–µ–º—ñ 5MB-—Ç–∞–Ω –∞—Å–ø–∞—É—ã –∫–µ—Ä–µ–∫!');
            return false;
        }
    }
});
</script>

<style>
.form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.img-thumbnail {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 5px;
    background-color: #f8f9fa;
}
</style>
{% endblock %}